{
  "active": false,
  "connections": {
    "Code in JavaScript1": {
      "main": [
        [
          {
            "index": 0,
            "node": "Switch1",
            "type": "main"
          }
        ]
      ]
    },
    "Get a file1": {
      "main": [
        [
          {
            "index": 0,
            "node": "Merge1",
            "type": "main"
          }
        ]
      ]
    },
    "Get many workflows1": {
      "main": [
        [
          {
            "index": 0,
            "node": "Loop Over Items1",
            "type": "main"
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "index": 0,
            "node": "Get a file1",
            "type": "main"
          },
          {
            "index": 1,
            "node": "Merge1",
            "type": "main"
          }
        ],
        [
          {
            "index": 0,
            "node": "Replace Me1",
            "type": "main"
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "index": 0,
            "node": "Code in JavaScript1",
            "type": "main"
          }
        ]
      ]
    },
    "Replace Me1": {
      "main": [
        [
          {
            "index": 0,
            "node": "Loop Over Items1",
            "type": "main"
          }
        ]
      ]
    },
    "Schedule Trigger1": {
      "main": [
        [
          {
            "index": 0,
            "node": "Variables1",
            "type": "main"
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "index": 0,
            "node": "Create a file",
            "type": "main"
          }
        ],
        [
          {
            "index": 0,
            "node": "Edit a file1",
            "type": "main"
          }
        ]
      ]
    },
    "Variables1": {
      "main": [
        [
          {
            "index": 0,
            "node": "Get many workflows1",
            "type": "main"
          }
        ]
      ]
    }
  },
  "name": "Back up errores",
  "nodes": [
    {
      "credentials": {
        "githubApi": {
          "id": "0oW4lU9Qr31YmzID",
          "name": "GitHub account"
        }
      },
      "name": "Create a file",
      "parameters": {
        "commitMessage": "=feat(n8n): add {{ $json[\"filePath\"] }}",
        "fileContent": "={{ $json[\"n8n_data_stringy\"] }}",
        "filePath": "={{ $json[\"filePath\"] }}",
        "owner": {
          "__rl": true,
          "mode": "name",
          "value": "joelrandolifarrando-hash"
        },
        "repository": {
          "__rl": true,
          "mode": "name",
          "value": "n8n_back"
        },
        "resource": "file"
      },
      "type": "n8n-nodes-base.github",
      "typeVersion": 1.1,
      "webhookId": "6c02b6cd-2487-43dd-b220-a966bcd42cda"
    },
    {
      "credentials": {
        "githubApi": {
          "id": "0oW4lU9Qr31YmzID",
          "name": "GitHub account"
        }
      },
      "name": "Edit a file1",
      "parameters": {
        "commitMessage": "=feat(n8n): add {{ $json[\"filePath\"] }}",
        "fileContent": "={{ $json[\"n8n_data_stringy\"] }}",
        "filePath": "={{ $json[\"filePath\"] }}",
        "operation": "edit",
        "owner": {
          "__rl": true,
          "mode": "name",
          "value": "joelrandolifarrando-hash"
        },
        "repository": {
          "__rl": true,
          "mode": "name",
          "value": "n8n_back"
        },
        "resource": "file"
      },
      "type": "n8n-nodes-base.github",
      "typeVersion": 1.1,
      "webhookId": "6c02b6cd-2487-43dd-b220-a966bcd42cda"
    },
    {
      "credentials": {
        "githubApi": {
          "id": "0oW4lU9Qr31YmzID",
          "name": "GitHub account"
        }
      },
      "name": "Get a file1",
      "onError": "continueRegularOutput",
      "parameters": {
        "asBinaryProperty": false,
        "filePath": "={{ $('Variables1').item.json.repo.path }}",
        "operation": "get",
        "owner": {
          "__rl": true,
          "mode": "name",
          "value": "joelrandolifarrando-hash"
        },
        "repository": {
          "__rl": true,
          "mode": "name",
          "value": "n8n_back"
        },
        "resource": "file"
      },
      "type": "n8n-nodes-base.github",
      "typeVersion": 1.1,
      "webhookId": "4877ee34-bc78-45fa-9471-7f325b186b4c"
    },
    {
      "credentials": {
        "n8nApi": {
          "id": "6ZQnv1rWnE7tteZ3",
          "name": "n8n account"
        }
      },
      "name": "Get many workflows1",
      "type": "n8n-nodes-base.n8n",
      "typeVersion": 1
    },
    {
      "name": "Code in JavaScript1",
      "parameters": {
        "jsCode": "// ========== CONFIG ==========\nconst BRANCH = 'main';\n\n// ========== Utils ==========\nfunction isObject(v){ return v && typeof v === 'object' && !Array.isArray(v); }\nfunction looksLikeWorkflow(o){ return o && isObject(o) && Array.isArray(o.nodes) && isObject(o.connections); }\n\nfunction tryParseJson(s){ try { return JSON.parse(s); } catch { return null; } }\nfunction tryParseBase64Json(s){\n  try {\n    const txt = Buffer.from(String(s).replace(/\\s+/g,''), 'base64').toString('utf8');\n    return JSON.parse(txt);\n  } catch { return null; }\n}\n\nfunction slug(s){\n  return String(s||'workflow')\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n    .replace(/[^a-zA-Z0-9-_]+/g,'-')\n    .replace(/-+/g,'-')\n    .replace(/^-|-$/g,'')\n    .toLowerCase();\n}\n\n// ===== Campos volátiles que NO versionamos =====\nconst VOLATILE_TOP  = new Set(['id','createdAt','updatedAt','versionId','meta','hash','staticData']);\nconst VOLATILE_NODE = new Set(['id','createdAt','updatedAt','position','notes','notesInFlow']);\n\n// ===== Normalización estable (clave para detectar \"igual\") =====\nfunction deepSort(obj){\n  if (Array.isArray(obj)){\n    return obj.map(deepSort)\n      .sort((a,b)=> JSON.stringify(a).localeCompare(JSON.stringify(b)));\n  }\n  if (!isObject(obj)) return obj;\n  const out = {};\n  for (const k of Object.keys(obj).sort()) out[k] = deepSort(obj[k]);\n  return out;\n}\n\nfunction stripVolatile(wf){\n  if (!wf || !isObject(wf)) return wf;\n  const c = JSON.parse(JSON.stringify(wf));\n\n  // Top-level volátiles fuera\n  for (const k of VOLATILE_TOP) delete c[k];\n\n  // Asegura conexiones como objeto\n  c.connections = deepSort(c.connections || {});\n\n  // Nodos: quita volátiles, normaliza y ordena por nombre\n  if (Array.isArray(c.nodes)){\n    c.nodes = c.nodes\n      .map(n=>{\n        const nn = {...n};\n        for (const k of VOLATILE_NODE) delete nn[k];\n        if (nn.credentials && isObject(nn.credentials)) nn.credentials = deepSort(nn.credentials);\n        if (nn.parameters) nn.parameters = deepSort(nn.parameters);\n        return nn;\n      })\n      .sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));\n  }\n\n  // Orden canónico del resto\n  return deepSort(c);\n}\n\nfunction same(a,b){ return JSON.stringify(a) === JSON.stringify(b); }\n\n// ===== Detección de LOCAL (busca en profundidad si hace falta) =====\nfunction findWorkflowDeep(obj){\n  const stack = [{v: obj, p: '$'}];\n  while (stack.length){\n    const {v,p} = stack.pop();\n    if (looksLikeWorkflow(v)) return {wf: v, path: p};\n    if (Array.isArray(v)) v.forEach((el,i)=> stack.push({v: el, p: `${p}[${i}]`}));\n    else if (isObject(v)) for (const [k,val] of Object.entries(v)) stack.push({v: val, p: `${p}.${k}`});\n  }\n  return {wf: null, path: null};\n}\n\n// ===== Detección de REMOTO (JSON, Binary y fallback solo SHA) =====\nfunction extractRemoteFromJson(root){\n  const stack = [root];\n  while (stack.length){\n    const v = stack.pop();\n    if (v && typeof v === 'object' && !Array.isArray(v)){\n      // Respuesta típica de GitHub /contents\n      if (typeof v.content === 'string' && /base64/i.test(v.encoding||'')){\n        const parsed = tryParseBase64Json(v.content);\n        if (looksLikeWorkflow(parsed)){\n          return { wf: parsed, sha: typeof v.sha==='string'? v.sha : null, path: v.path || null, source: 'json.content(base64)' };\n        }\n      }\n      for (const val of Object.values(v)) stack.push(val);\n    }\n  }\n  return { wf: null, sha: null, path: null, source: null };\n}\n\nfunction extractRemoteFromBinary(binary){\n  if (!binary || !isObject(binary)) return { wf:null, sha:null, path:null, source:null };\n  for (const [k,b] of Object.entries(binary)){\n    if (b && typeof b.data === 'string'){\n      const parsed = tryParseBase64Json(b.data);\n      if (looksLikeWorkflow(parsed)) return { wf: parsed, sha: null, path: null, source: `binary.${k}.data` };\n    }\n  }\n  return { wf:null, sha:null, path:null, source:null };\n}\n\nfunction extractShaPathOnly(root){\n  const hex40 = /^[0-9a-f]{40}$/i;\n  const stack = [root];\n  while (stack.length){\n    const v = stack.pop();\n    if (v && typeof v === 'object' && !Array.isArray(v)){\n      if (typeof v.sha==='string' && hex40.test(v.sha)){\n        return { sha: v.sha, path: typeof v.path==='string' ? v.path : null, source: 'json.shaOnly' };\n      }\n      for (const val of Object.values(v)) stack.push(val);\n    }\n  }\n  return { sha:null, path:null, source:null };\n}\n\n// ===== Emparejador por filePath (independiente del Merge) =====\nconst buckets = new Map(); // key=filePath → { local, remote, sha, filePath }\n\nfunction ensureBucket(key){\n  if (!buckets.has(key)) buckets.set(key, { local:null, remote:null, sha:null, filePath:key });\n  return buckets.get(key);\n}\n\n// 1) Recolectar TODOS los items (vengan de Get, Loop, Merge…)\nfor (const item of items){\n  const j = item.json || {};\n\n  // ---- LOCAL ----\n  let local = j.localWorkflow || j.workflow || (looksLikeWorkflow(j) ? j : null);\n  if (!local){\n    const fl = findWorkflowDeep(j);\n    local = fl.wf;\n  }\n  if (local){\n    const nombre = slug(local.name || local.id || 'workflow');\n    const filePath = `workflows/${nombre}.json`;\n    const normLocal = stripVolatile(local);\n    const b = ensureBucket(filePath);\n    b.local = normLocal;\n    b.filePath = filePath;\n  }\n\n  // ---- REMOTO: JSON ----\n  const rj = extractRemoteFromJson(j);\n  if (rj.wf){\n    const filePath = rj.path || (()=>{\n      const nombre = slug(rj.wf.name || rj.wf.id || 'workflow');\n      return `workflows/${nombre}.json`;\n    })();\n    const b = ensureBucket(filePath);\n    b.remote = stripVolatile(rj.wf);\n    if (rj.sha) b.sha = rj.sha;\n    b.filePath = filePath;\n  } else {\n    // ---- REMOTO: Binary ----\n    const rb = extractRemoteFromBinary(item.binary);\n    if (rb.wf){\n      const filePath = rb.path || (()=>{\n        const nombre = slug(rb.wf.name || rb.wf.id || 'workflow');\n        return `workflows/${nombre}.json`;\n      })();\n      const b = ensureBucket(filePath);\n      b.remote = stripVolatile(rb.wf);\n      b.filePath = filePath;\n    } else {\n      // ---- Fallback: solo SHA (archivo existe aunque no podamos leer content) ----\n      const sp = extractShaPathOnly(j);\n      if (sp.sha){\n        const filePath = sp.path || (()=>{\n          const anyLocal = [...buckets.values()].find(x=>x.local)?.filePath || null;\n          return anyLocal;\n        })();\n        if (filePath){\n          const b = ensureBucket(filePath);\n          if (!b.sha) b.sha = sp.sha;\n          if (!b.filePath) b.filePath = filePath;\n        }\n      }\n    }\n  }\n}\n\n// 2) Decisión por filePath: 0/1/2\nconst output = [];\nfor (const [key,b] of buckets){\n  if (!b.local){\n    output.push({ json: { accion: -1, estado: 'error', mensaje: 'No se detectó workflow LOCAL', filePath: key } });\n    continue;\n  }\n  const n8n_data_stringy = Buffer.from(JSON.stringify(b.local, null, 2)).toString('base64');\n  const shaOk = (typeof b.sha === 'string') && /^[0-9a-f]{40}$/i.test(b.sha);\n\n  let accion, estado, reason;\n  if (b.remote){\n    if (same(b.local, b.remote)){\n      accion = 0; estado = 'igual'; reason = 'local==remoto (normalizado)';\n    } else if (shaOk){\n      accion = 1; estado = 'diferente'; reason = 'diff && sha válido';\n    } else {\n      accion = 2; estado = 'crear'; reason = 'diff pero sin sha (evita 422)';\n    }\n  } else if (shaOk){\n    // Sabemos que existe (hay sha), pero no pudimos leer content (p.ej. truncado)\n    accion = 1; estado = 'editar_sin_diff'; reason = 'sha presente sin contenido remoto';\n  } else {\n    accion = 2; estado = 'crear'; reason = 'no hay remoto ni sha';\n  }\n\n  output.push({\n    json: {\n      accion,          // 0=no-op, 1=editar, 2=crear, -1=error\n      estado,\n      reason,\n      filePath: b.filePath || key,\n      n8n_data_stringy,\n      sha: b.sha || undefined,\n      branch: BRANCH,\n      debug: { haveRemote: !!b.remote, haveSha: !!b.sha }\n    }\n  });\n}\n\nreturn output;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2
    },
    {
      "name": "Loop Over Items1",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3
    },
    {
      "name": "Merge1",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2
    },
    {
      "name": "Replace Me1",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1
    },
    {
      "name": "Schedule Trigger1",
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2
    },
    {
      "name": "Switch1",
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "id": "2ecb2e0e-af9d-4cce-9d0f-264b33506246",
                    "leftValue": "={{$json[\"accion\"]}}",
                    "operator": {
                      "operation": "equals",
                      "type": "number"
                    },
                    "rightValue": 2
                  }
                ],
                "options": {
                  "caseSensitive": true,
                  "typeValidation": "strict",
                  "version": 2
                }
              }
            },
            {
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "id": "397c9046-5c18-4120-86cb-e36c8c6d1c0b",
                    "leftValue": "={{ $json[\"accion\"] }}",
                    "operator": {
                      "operation": "equals",
                      "type": "number"
                    },
                    "rightValue": 0
                  }
                ],
                "options": {
                  "caseSensitive": true,
                  "typeValidation": "strict",
                  "version": 2
                }
              }
            },
            {
              "conditions": {
                "combinator": "and",
                "conditions": [
                  {
                    "id": "4c57f43a-ee59-4a5d-b2b0-7a7ef2c8e66e",
                    "leftValue": "={{$json[\"accion\"]}}",
                    "operator": {
                      "operation": "equals",
                      "type": "number"
                    },
                    "rightValue": 1
                  }
                ],
                "options": {
                  "caseSensitive": true,
                  "typeValidation": "strict",
                  "version": 2
                }
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2
    },
    {
      "name": "Variables1",
      "parameters": {
        "jsonOutput": "{\n  \"repo\": {\n    \"owner\": \"joelrandolifarrandoli-hash\",\n    \"name\": \"n8n_back\",\n    \"branch\": \"main\",\n    \"path\": \"workflows\"\n  }\n}\n",
        "mode": "raw"
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4
    }
  ],
  "shared": [
    {
      "createdAt": "2025-09-09T09:16:49.880Z",
      "projectId": "M3s0TPMuzmMgAN7B",
      "role": "workflow:owner",
      "updatedAt": "2025-09-09T09:16:49.880Z",
      "workflowId": "gCpWThAhPhewWYaK"
    }
  ],
  "triggerCount": 0
}